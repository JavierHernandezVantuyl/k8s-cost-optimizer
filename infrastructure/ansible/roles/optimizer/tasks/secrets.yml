---
# Secrets management for optimizer

- name: Create PostgreSQL credentials secret
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: postgres-credentials
        namespace: "{{ optimizer_namespace }}"
      type: Opaque
      stringData:
        host: "{{ postgres_host }}"
        port: "{{ postgres_port | default('5432') }}"
        database: "{{ postgres_database }}"
        username: "{{ postgres_username }}"
        password: "{{ postgres_password }}"
  when: create_secrets | default(true)
  no_log: true

- name: Create Redis credentials secret
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: redis-credentials
        namespace: "{{ optimizer_namespace }}"
      type: Opaque
      stringData:
        host: "{{ redis_host }}"
        port: "{{ redis_port | default('6379') }}"
        password: "{{ redis_password | default('') }}"
  when: create_secrets | default(true)
  no_log: true

- name: Create storage credentials secret
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: storage-credentials
        namespace: "{{ optimizer_namespace }}"
      type: Opaque
      stringData:
        endpoint: "{{ storage_endpoint }}"
        bucket: "{{ storage_bucket }}"
        access_key: "{{ storage_access_key }}"
        secret_key: "{{ storage_secret_key }}"
  when: create_secrets | default(true)
  no_log: true
