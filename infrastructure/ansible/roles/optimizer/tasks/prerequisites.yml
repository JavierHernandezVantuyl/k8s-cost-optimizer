---
# Prerequisites for optimizer deployment

- name: Check kubectl is installed
  ansible.builtin.command: kubectl version --client
  register: kubectl_version
  changed_when: false
  failed_when: kubectl_version.rc != 0

- name: Check helm is installed
  ansible.builtin.command: helm version
  register: helm_version
  changed_when: false
  failed_when: helm_version.rc != 0

- name: Verify cluster connectivity
  kubernetes.core.k8s_cluster_info:
    kubeconfig: "{{ kubeconfig }}"
  register: cluster_info

- name: Check if namespace exists
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig }}"
    kind: Namespace
    name: "{{ optimizer_namespace }}"
  register: namespace_check

- name: Create namespace if not exists
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ optimizer_namespace }}"
        labels:
          name: "{{ optimizer_namespace }}"
          environment: "{{ environment }}"
  when: namespace_check.resources | length == 0
